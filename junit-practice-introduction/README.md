# 第10章　カテゴリ化テスト

## スローテスト問題

* ユニットテストは、短いサイクルで実行して素早くフィードバックを得る事が重要
* 遅いユニットテストが増えてくると、素早くフィードバクを得ることができなくなってくる
* 全ユニットテストの実行に10分以上かかるようであれば、スローテスト問題が発生しているといえる

### 対策

* テストの実行時間を短くする
* テストの実行環境を強化する
* テストを並列で実行する
* 実行するテストを絞り込む

#### テストの実行時間を短くする

* テストデータを共有化したり
* モックオブジェクトに差し替えたり
* この方法はスローテスト問題を根本的に解決するが、テストコードを大きく変更するため、リスクも高く時間もかかる
* 殆どの場合は最終手段とするべき
* パフォーマンスを考慮したテストコードを書くこともできるが、可読性を落としては元も子もない

#### テストの実行環境を強化する

* テストを実行するマシンのスペックを上げる事で、テストの実行速度を高めてスローテスト問題の対策を行う
* マシンを調達さえ出来ればいいので、リスクが殆ど無い
* 人のコストよりもマシンの方が安い

#### テストを並列で実行する

* テストを複数のマシンで並列に実行する
* テストを並列で実行するには、テストケースがお互いに独立して実行順に依存しない設計になっていないといけない
* 後からこの条件を満たそうとするのは非常に困難
* 効果的に分割できないと思ったよりも効果はでない

#### 実行するテストを絞り込む

* テストの目的に応じて実行するテストケースを絞り込んで実行する
* あまり重要でないテストや時間のかかるテストは1日1回など定期的に行い、それ以外のテストは常時実行するなど
* ユニットテストの素早いフィードバックを損なわずにテストの実行時間を短縮できる

## カテゴリ化テスト

JUnit4.8 で追加された**カテゴリ**を使うことでテストを絞り込む方法。

### カテゴリ化テストとは

* アノテーションでタグ付けされたテストケースから特定のタグを含む（または含まない）テストケースのみを実行する仕組み
* 目的に応じたテストを任意のタイミングで実行できる
* アノテーションを付与するだけで実現できるため、カテゴリかテストの実行とは無関係に低コストで行える

### カテゴリ化テストの実行

1. カテゴリの種類を表すカテゴリクラスを作成する
2. テストケースまたはテストクラスにカテゴリを設定する
3. カテゴリ化テストを実行するためのテストスイートクラスを作成する

Maven などテストを実行するビルドツールが JUnit のカテゴリかテストに対応している場合、3. の手順は不要。

#### カテゴリクラスを作成する

* カテゴリを特定するマーカークラス（マーカーインタフェース）を作成する
* クラス名はテストクラスの命名規則と衝突しないように、`*Tests` や `*TestCategory` などとする
* いくつ定義しても問題ない

```java
public class SlowTests {
}
public class FastTests {
}
```

#### テストケースにカテゴリを指定する

* `org.junit.experimental.categories.Category` アノテーションを使用してテストメソッドにカテゴリを指定
* `@Category` アノテーションの `value` 属性に、定義したカテゴリクラスを指定する
* テストクラスに定義することもでき、その場合はすべてのテストメソッドに属する
* 複数のカテゴリを指定することもできる
  * `@Category({FooTests.class, BarTests.class})`

```java
public class FooTest {
    @Category(FastTests.class)
    @Test
    public void fastTest() throws Exception {
        System.out.println("FooTest#fastTest");

    }

    @Category(SlowTests.class)
    @Test
    public void slowTest() throws Exception {
        System.out.println("FooTest#slowTest");
    }
}
```

#### テストスイートクラスを作成する

* 複数のテストクラスに含まれるテストケースをまとめて実行するには、テストスイートクラスを作成する必要がある
* カテゴリ化テストでは、`Suite` テストランナーの代わりに `org.junit.experimental.categories.Categories` テストランナーを使う
* 対象となるテストクラスの指定は、`Suite` と同様に `@SuiteClasses` アノテーションを利用する
* 実行するカテゴリの指定は、`@IncludeCategory` と `@ExcludeCategory` アノテーションを利用する

```java
@RunWith(Categories.class)
@Categories.IncludeCategory(FastTests.class)
@Categories.ExcludeCategory(SlowTests.class)
@Suite.SuiteClasses({FooTest.class, BarTest.class})
public class CategorizedTest {
}
```

## カテゴリ化テストのパターン

* スローテスト問題が発生し、カテゴリ化テストが必要となるパターンはそれほど多くない
* 該当するなら、開発の初期段階でカテゴリクラスを作成し、テストケースのカテゴリ化を行っておくとよい

### データベーステスト

* データベースの初期化やコネクションの作成／解放はコストがかかる

### 通信処理を伴うテスト

* ネットワークを使用するテストの実行速度はネットワークの状態に依存しやすく、遅くなりがち
* 常に外部サービスを利用できるとも限らないため、テストが不安定になりやすい
* 相手先に大きな負荷を与えてしまうこともある
* テストダブルを使ってテストするか、実行する頻度を制御しておく必要がある

### GUI を伴うテスト

* ブラウザや Swing などの GUI の操作を含んだテストもスローテスト問題を起こしやすい
* レンダリング処理などがコストが大きい

## ビルドツールによるカテゴリ化テスト

* ビルドツールでは独自にテストクラスとテストケースを収集するためテストスイートを作成する必要がない
* Maven などは設定ファイルに対象カテゴリを指定することでカテゴリ化テストを実行できる
